name: GLPI GMUD (Auditoria)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Simular integração (não chama GLPI)"
        required: true
        default: "true"

permissions:
  contents: read

# DRY_RUN só existe no workflow_dispatch; em push/PR vira "false"
env:
  DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}

jobs:
  gmud_open_and_validate:
    runs-on: ubuntu-latest
    outputs:
      change_id: ${{ steps.create_change.outputs.CHANGE_ID }}
    env:
      GLPI_API_BASE: ${{ secrets.GLPI_API_BASE }}
      APP_TOKEN: ${{ secrets.GLPI_APP_TOKEN }}
      USER_TOKEN: ${{ secrets.GLPI_USER_TOKEN }}
      CATEGORY_ID: ${{ secrets.GLPI_CHANGE_CATEGORY_ID }}
      STATUS_APPROVAL_REQUIRED: "3"   # ajuste conforme seu GLPI
    steps:
      - uses: actions/checkout@v4

      - name: Ensure jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Compute ref
        id: ref
        shell: bash
        run: |
          set -euo pipefail
          if [[ -n "${GITHUB_HEAD_REF:-}" ]]; then
            echo "ref_name=${GITHUB_HEAD_REF}" >> "$GITHUB_OUTPUT"
          else
            echo "ref_name=${GITHUB_REF##*/}" >> "$GITHUB_OUTPUT"
          fi

      - name: Init GLPI session
        if: env.DRY_RUN != 'true'
        id: glpi_session
        shell: bash
        run: |
          set -euo pipefail
          resp=$(curl -sS -w "\n%{http_code}" -X GET \
            -H "Content-Type: application/json" \
            -H "App-Token: ${APP_TOKEN}" \
            -H "Authorization: user_token ${USER_TOKEN}" \
            "${GLPI_API_BASE}/initSession")
          body=$(echo "$resp" | sed '$d'); code=$(echo "$resp" | tail -n1)
          session=$(echo "$body" | jq -r '.session_token // empty' 2>/dev/null || true)
          if [[ -z "${session}" ]]; then
            echo "ERRO initSession (http $code)"
            echo "$body"
            exit 1
          fi
          echo "SESSION_TOKEN=${session}" >> "$GITHUB_OUTPUT"

      - name: Create Change (DRY/REAL)
        id: create_change
        shell: bash
        env:
          SESSION_TOKEN: ${{ steps.glpi_session.outputs.SESSION_TOKEN }}
        run: |
          set -euo pipefail
          REF="${{ steps.ref.outputs.ref_name }}"

          if [[ "${DRY_RUN}" == "true" ]]; then
            echo "DRY_RUN=true -> Simulando criação de GMUD (sem GLPI)"
            echo "Repo: ${GITHUB_REPOSITORY}"
            echo "Ref: ${REF}"
            echo "CHANGE_ID=TEST-${GITHUB_RUN_ID}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          TITLE="[GMUD][GITHUB] ${GITHUB_REPOSITORY} - ${REF} - ${GITHUB_SHA:0:7}"
          BODY="GMUD criada automaticamente pelo GitHub Actions.
Run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          # Inclui categoria se existir
          if [[ -n "${CATEGORY_ID:-}" ]]; then
            PAYLOAD=$(jq -n --arg name "$TITLE" --arg content "$BODY" --argjson itilcategories_id "${CATEGORY_ID}" \
              '{input:{name:$name, content:$content, itilcategories_id:$itilcategories_id}}')
          else
            PAYLOAD=$(jq -n --arg name "$TITLE" --arg content "$BODY" '{input:{name:$name, content:$content}}')
          fi

          resp=$(curl -sS -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -H "Session-Token: ${SESSION_TOKEN}" \
            -H "App-Token: ${APP_TOKEN}" \
            -d "${PAYLOAD}" \
            "${GLPI_API_BASE}/Change")
          body=$(echo "$resp" | sed '$d'); code=$(echo "$resp" | tail -n1)
          CHANGE_ID=$(echo "$body" | jq -r '.id // .ids[0] // empty' 2>/dev/null || true)
          if [[ -z "${CHANGE_ID}" ]]; then
            echo "ERRO create Change (http $code)"
            echo "$body"
            exit 1
          fi
          echo "CHANGE_ID=${CHANGE_ID}" >> "$GITHUB_OUTPUT"

      - name: Post followup - start
        if: env.DRY_RUN != 'true'
        shell: bash
        env:
          SESSION_TOKEN: ${{ steps.glpi_session.outputs.SESSION_TOKEN }}
          CHANGE_ID: ${{ steps.create_change.outputs.CHANGE_ID }}
        run: |
          set -euo pipefail
          FOLLOW=$(jq -n \
            --arg itemtype "Change" \
            --argjson items_id "${CHANGE_ID}" \
            --arg content "Início da validação técnica no pipeline. Run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}" \
            '{input:{itemtype:$itemtype, items_id:$items_id, content:$content, is_private:0}}')
          curl -sS -X POST \
            -H "Content-Type: application/json" \
            -H "Session-Token: ${SESSION_TOKEN}" \
            -H "App-Token: ${APP_TOKEN}" \
            -d "${FOLLOW}" \
            "${GLPI_API_BASE}/ITILFollowup"

      - name: Validation (placeholder)
        shell: bash
        run: |
          set -euo pipefail
          echo "Executar testes/build/scans aqui..."

      - name: Mark awaiting approval
        if: env.DRY_RUN != 'true'
        shell: bash
        env:
          SESSION_TOKEN: ${{ steps.glpi_session.outputs.SESSION_TOKEN }}
          CHANGE_ID: ${{ steps.create_change.outputs.CHANGE_ID }}
        run: |
          set -euo pipefail
          PAYLOAD=$(jq -n --argjson status "${STATUS_APPROVAL_REQUIRED}" '{input:{status:$status}}')
          curl -sS -X PUT \
            -H "Content-Type: application/json" \
            -H "Session-Token: ${SESSION_TOKEN}" \
            -H "App-Token: ${APP_TOKEN}" \
            -d "${PAYLOAD}" \
            "${GLPI_API_BASE}/Change/${CHANGE_ID}"

      - name: Kill GLPI session
        if: always() && env.DRY_RUN != 'true'
        shell: bash
        env:
          SESSION_TOKEN: ${{ steps.glpi_session.outputs.SESSION_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -n "${SESSION_TOKEN:-}" ]]; then
            curl -sS -X GET \
              -H "Session-Token: ${SESSION_TOKEN}" \
              -H "App-Token: ${APP_TOKEN}" \
              "${GLPI_API_BASE}/killSession" >/dev/null || true
          fi

  deploy_with_approval:
    needs: [gmud_open_and_validate]
    runs-on: ubuntu-latest

    # ✅ Gate de aprovação: configure "Required reviewers" no Environment production
    environment: production

    env:
      GLPI_API_BASE: ${{ secrets.GLPI_API_BASE }}
      APP_TOKEN: ${{ secrets.GLPI_APP_TOKEN }}
      USER_TOKEN: ${{ secrets.GLPI_USER_TOKEN }}
      CHANGE_ID: ${{ needs.gmud_open_and_validate.outputs.change_id }}
      STATUS_IMPLEMENTED: "6" # ajuste conforme seu GLPI
      STATUS_ROLLBACK: "11"   # ajuste conforme seu GLPI
    steps:
      - uses: actions/checkout@v4

      - name: Ensure jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Init GLPI session
        if: env.DRY_RUN != 'true'
        id: glpi_session
        shell: bash
        run: |
          set -euo pipefail
          resp=$(curl -sS -w "\n%{http_code}" -X GET \
            -H "Content-Type: application/json" \
            -H "App-Token: ${APP_TOKEN}" \
            -H "Authorization: user_token ${USER_TOKEN}" \
            "${GLPI_API_BASE}/initSession")
          body=$(echo "$resp" | sed '$d'); code=$(echo "$resp" | tail -n1)
          session=$(echo "$body" | jq -r '.session_token // empty' 2>/dev/null || true)
          if [[ -z "${session}" ]]; then
            echo "ERRO initSession (http $code)"
            echo "$body"
            exit 1
          fi
          echo "SESSION_TOKEN=${session}" >> "$GITHUB_OUTPUT"

      - name: Registrar aprovação (evidência)
        shell: bash
        env:
          SESSION_TOKEN: ${{ steps.glpi_session.outputs.SESSION_TOKEN }}
        run: |
          set -euo pipefail
          if [[ "${DRY_RUN}" == "true" ]]; then
            echo "(DRY RUN) Aprovação gerencial registrada para CHANGE_ID=${CHANGE_ID}"
            exit 0
          fi

          FOLLOW=$(jq -n \
            --arg itemtype "Change" \
            --argjson items_id "${CHANGE_ID}" \
            --arg content "Aprovação gerencial concedida no GitHub Environment 'production'. Iniciando deploy. Run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}" \
            '{input:{itemtype:$itemtype, items_id:$items_id, content:$content, is_private:0}}')
          curl -sS -X POST \
            -H "Content-Type: application/json" \
            -H "Session-Token: ${SESSION_TOKEN}" \
            -H "App-Token: ${APP_TOKEN}" \
            -d "${FOLLOW}" \
            "${GLPI_API_BASE}/ITILFollowup"

      - name: Deploy (placeholder)
        id: deploy
        shell: bash
        run: |
          set -euo pipefail
          echo "Execute seu deploy aqui..."

      - name: Marcar GMUD como implementada + evidência
        if: env.DRY_RUN != 'true'
        shell: bash
        env:
          SESSION_TOKEN: ${{ steps.glpi_session.outputs.SESSION_TOKEN }}
        run: |
          set -euo pipefail
          PAYLOAD=$(jq -n --argjson status "${STATUS_IMPLEMENTED}" '{input:{status:$status}}')
          curl -sS -X PUT \
            -H "Content-Type: application/json" \
            -H "Session-Token: ${SESSION_TOKEN}" \
            -H "App-Token: ${APP_TOKEN}" \
            -d "${PAYLOAD}" \
            "${GLPI_API_BASE}/Change/${CHANGE_ID}"

          FOLLOW=$(jq -n \
            --arg itemtype "Change" \
            --argjson items_id "${CHANGE_ID}" \
            --arg content "Deploy concluído com sucesso. GMUD marcada como implementada." \
            '{input:{itemtype:$itemtype, items_id:$items_id, content:$content, is_private:0}}')
          curl -sS -X POST \
            -H "Content-Type: application/json" \
            -H "Session-Token: ${SESSION_TOKEN}" \
            -H "App-Token: ${APP_TOKEN}" \
            -d "${FOLLOW}" \
            "${GLPI_API_BASE}/ITILFollowup"

      - name: Rollback (se falhar)
        if: failure()
        id: rollback
        shell: bash
        run: |
          set -euo pipefail
          echo "Executando rollback..."
          echo "Rollback OK."

      - name: Marcar GMUD como rollback + evidência
        if: failure() && env.DRY_RUN != 'true'
        shell: bash
        env:
          SESSION_TOKEN: ${{ steps.glpi_session.outputs.SESSION_TOKEN }}
        run: |
          set -euo pipefail
          PAYLOAD=$(jq -n --argjson status "${STATUS_ROLLBACK}" '{input:{status:$status}}')
          curl -sS -X PUT \
            -H "Content-Type: application/json" \
            -H "Session-Token: ${SESSION_TOKEN}" \
            -H "App-Token: ${APP_TOKEN}" \
            -d "${PAYLOAD}" \
            "${GLPI_API_BASE}/Change/${CHANGE_ID}"

          FOLLOW=$(jq -n \
            --arg itemtype "Change" \
            --argjson items_id "${CHANGE_ID}" \
            --arg content "Falha no deploy/pipeline. Rollback executado. Ver run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}" \
            '{input:{itemtype:$itemtype, items_id:$items_id, content:$content, is_private:0}}')
          curl -sS -X POST \
            -H "Content-Type: application/json" \
            -H "Session-Token: ${SESSION_TOKEN}" \
            -H "App-Token: ${APP_TOKEN}" \
            -d "${FOLLOW}" \
            "${GLPI_API_BASE}/ITILFollowup"

      - name: Kill GLPI session
        if: always() && env.DRY_RUN != 'true'
        shell: bash
        env:
          SESSION_TOKEN: ${{ steps.glpi_session.outputs.SESSION_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -n "${SESSION_TOKEN:-}" ]]; then
            curl -sS -X GET \
              -H "Session-Token: ${SESSION_TOKEN}" \
              -H "App-Token: ${APP_TOKEN}" \
              "${GLPI_API_BASE}/killSession" >/dev/null || true
          fi
