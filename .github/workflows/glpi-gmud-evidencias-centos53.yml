---
name: GLPI GMUD - Evidências + Precheck CentOS53

"on":
  workflow_dispatch:

permissions:
  contents: read

jobs:
  gmud_evidences_and_precheck:
    runs-on: self-hosted

    env:
      DRY_RUN: "true"
      GLPI_API_BASE: ${{ secrets.GLPI_API_BASE }}
      APP_TOKEN: ${{ secrets.GLPI_APP_TOKEN }}
      USER_TOKEN: ${{ secrets.GLPI_USER_TOKEN }}
      CATEGORY_ID: ${{ secrets.GLPI_CHANGE_CATEGORY_ID }}

      SSH_HOST: "192.168.0.53"
      SSH_PORT: "22"

    steps:
      - uses: actions/checkout@v4

      - name: Preparar ferramentas
        shell: bash
        run: |
          set -euo pipefail
          sudo dnf install -y jq yamllint nc iproute iputils procps-ng

      - name: Preparar pasta de evidências
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p evidence
          date -Is > evidence/data_execucao.txt
          echo "${{ github.repository }}" > evidence/repositorio.txt
          echo "${{ github.sha }}" > evidence/commit.txt
          hostname > evidence/runner_hostname.txt

      - name: Validar YAML do workflow de evidências
        shell: bash
        run: |
          set -euo pipefail
          yamllint \
            -d '{extends: default, rules: {document-start: disable, truthy: disable, line-length: disable, empty-lines: {max: 2, max-start: 0, max-end: 0}}}' \
            -f parsable \
            .github/workflows/glpi-gmud-evidencias-centos53.yml | tee evidence/yamllint.txt

      - name: Simulação de GMUD (somente evidência)
        shell: bash
        run: |
          set -euo pipefail
          echo "Modo DRY-RUN habilitado. Nenhuma GMUD real será criada." | tee evidence/gmud_simulacao.txt

      - name: Pre-check CentOS 9 - 192.168.0.53 (evidência local – sem falhar por ping)
        shell: bash
        run: |
          set -euo pipefail

          echo "== DATA / HORA ==" | tee evidence/precheck_time.txt
          date -Is | tee -a evidence/precheck_time.txt

          echo "== HOSTNAMECTL ==" | tee evidence/hostnamectl.txt
          hostnamectl | tee -a evidence/hostnamectl.txt

          echo "== OS RELEASE ==" | tee evidence/os-release.txt
          cat /etc/os-release | tee -a evidence/os-release.txt

          echo "== UPTIME ==" | tee evidence/uptime.txt
          uptime | tee -a evidence/uptime.txt

          echo "== CPU / MEM ==" | tee evidence/memoria.txt
          free -h | tee -a evidence/memoria.txt

          echo "== DISCO ==" | tee evidence/disco.txt
          df -h | tee -a evidence/disco.txt

          echo "== INTERFACES (ip a) ==" | tee evidence/ip_a.txt
          ip a | tee -a evidence/ip_a.txt

          echo "== ROTAS (ip route) ==" | tee evidence/ip_route.txt
          ip route | tee -a evidence/ip_route.txt

          echo "== PING ${SSH_HOST} (nao bloqueia pipeline) ==" | tee evidence/ping.txt
          ping -c 3 "${SSH_HOST}" | tee -a evidence/ping.txt || true

          echo "== PORTA SSH ${SSH_PORT} (nao bloqueia pipeline) ==" | tee evidence/porta_ssh.txt
          (nc -vz "${SSH_HOST}" "${SSH_PORT}" || true) | tee -a evidence/porta_ssh.txt

      - name: Publicar evidências
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evidencias-centos53
          path: evidence/
          if-no-files-found: warn
