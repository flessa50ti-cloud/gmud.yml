---
name: GLPI GMUD - Evidências + Precheck CentOS53

"on":
  workflow_dispatch:

permissions:
  contents: read

jobs:
  gmud_evidences_and_precheck:
    runs-on: ubuntu-latest

    env:
      DRY_RUN: "true"
      GLPI_API_BASE: ${{ secrets.GLPI_API_BASE }}
      APP_TOKEN: ${{ secrets.GLPI_APP_TOKEN }}
      USER_TOKEN: ${{ secrets.GLPI_USER_TOKEN }}
      CATEGORY_ID: ${{ secrets.GLPI_CHANGE_CATEGORY_ID }}
      SSH_HOST: "192.168.0.53"
      SSH_USER: "deploy"
      SSH_PORT: "22"
      SSH_PASSWORD: ${{ secrets.CENTOS53_DEPLOY_PASSWORD }}

    steps:
      - uses: actions/checkout@v4

      - name: Preparar ferramentas
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq sshpass yamllint netcat-openbsd

      - name: Preparar pasta de evidências
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p evidence
          date -Is > evidence/data_execucao.txt
          echo "${{ github.repository }}" > evidence/repositorio.txt
          echo "${{ github.sha }}" > evidence/commit.txt

      - name: Validar YAML do workflow de evidências
        shell: bash
        run: |
          set -euo pipefail
          yamllint \
            -d '{extends: default, rules: {document-start: disable, truthy: disable, line-length: disable, empty-lines: {max: 2, max-start: 0, max-end: 0}}}' \
            -f parsable \
            .github/workflows/glpi-gmud-evidencias-centos53.yml | tee evidence/yamllint.txt

      - name: Simulação de GMUD (somente evidência)
        shell: bash
        run: |
          set -euo pipefail
          echo "Modo DRY-RUN habilitado. Nenhuma GMUD real será criada." \
            | tee evidence/gmud_simulacao.txt

      - name: Pre-check CentOS 9 - 192.168.0.53 (evidência)
        shell: bash
        run: |
          set -euo pipefail
          ping -c 3 "${SSH_HOST}" | tee evidence/ping.txt
          (nc -vz "${SSH_HOST}" "${SSH_PORT}" || true) | tee evidence/porta_ssh.txt

          sshpass -p "${SSH_PASSWORD}" ssh \
            -o StrictHostKeyChecking=no \
            -o PreferredAuthentications=password \
            -o PubkeyAuthentication=no \
            -p "${SSH_PORT}" \
            "${SSH_USER}@${SSH_HOST}" \
            '
              echo "== HOSTNAMECTL ==";
              hostnamectl;
              echo "== OS-RELEASE ==";
              cat /etc/os-release;
              echo "== UPTIME ==";
              uptime;
              echo "== DISCO ==";
              df -h;
            ' | tee evidence/servidor_centos53.txt

      - name: Publicar evidências
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evidencias-centos53
          path: evidence/
          if-no-files-found: warn
